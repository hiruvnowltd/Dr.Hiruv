<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
    // Firebase configuration - ‡∂∏‡∑ö‡∑Ä‡∑è ‡∂î‡∂∫‡∑è‡∂ú‡∑ö Firebase project ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä replace ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Firebase database functions
    const firebaseDB = {
        // Set data
        setItem: async (key, value) => {
            try {
                await database.ref(key).set(value);
                return true;
            } catch (error) {
                console.error("Error setting data:", error);
                return false;
            }
        },

        // Get data
        getItem: async (key) => {
            try {
                const snapshot = await database.ref(key).once('value');
                return snapshot.exists() ? snapshot.val() : null;
            } catch (error) {
                console.error("Error getting data:", error);
                return null;
            }
        },

        // Remove data
        removeItem: async (key) => {
            try {
                await database.ref(key).remove();
                return true;
            } catch (error) {
                console.error("Error removing data:", error);
                return false;
            }
        },

        // Listen for real-time changes
        onItemChange: (key, callback) => {
            database.ref(key).on('value', (snapshot) => {
                const data = snapshot.exists() ? snapshot.val() : null;
                callback(data);
            });
        }
    };

    // Modified functions to use Firebase instead of localStorage
    async function loadExamDates() {
        try {
            const saved = await firebaseDB.getItem('examDates');
            if (saved) {
                examDates.biology = new Date(saved.biology);
                examDates.chemistry = new Date(saved.chemistry);
                examDates.physics = new Date(saved.physics);
            }
        } catch (error) {
            console.error('Error loading exam dates:', error);
        }
    }

    async function saveExamDates() {
        try {
            await firebaseDB.setItem('examDates', examDates);
        } catch (error) {
            console.error('Error saving exam dates:', error);
        }
    }

    // Modified MCQ functions for Firebase
    async function addMCQ(subject) {
        const question = document.getElementById(`${subject}Question`).value;
        const optionA = document.getElementById(`${subject}OptionA`).value;
        const optionB = document.getElementById(`${subject}OptionB`).value;
        const optionC = document.getElementById(`${subject}OptionC`).value;
        const optionD = document.getElementById(`${subject}OptionD`).value;
        const optionE = document.getElementById(`${subject}OptionE`).value;
        const correctAnswer = document.getElementById(`${subject}CorrectAnswer`).value;
        const statusDiv = document.getElementById(`${subject}McqStatus`);
        
        if (!question || !optionA || !optionB || !optionC || !optionD || !optionE) {
            statusDiv.innerHTML = '<div class="status-error">Please fill in all fields.</div>';
            return;
        }
        
        const mcq = {
            id: Date.now(),
            question: question,
            options: {
                A: optionA,
                B: optionB,
                C: optionC,
                D: optionD,
                E: optionE
            },
            correctAnswer: correctAnswer,
            timestamp: new Date().toISOString()
        };
        
        try {
            // Get existing polls from Firebase
            const existingPolls = await firebaseDB.getItem(`${subject}Polls`) || [];
            const polls = Array.isArray(existingPolls) ? existingPolls : [];
            
            // Add new poll
            polls.push(mcq);
            
            // Save to Firebase
            await firebaseDB.setItem(`${subject}Polls`, polls);
            
            statusDiv.innerHTML = '<div class="status-success">MCQ poll added successfully!</div>';
            
            // Clear form
            document.getElementById(`${subject}Question`).value = '';
            document.getElementById(`${subject}OptionA`).value = '';
            document.getElementById(`${subject}OptionB`).value = '';
            document.getElementById(`${subject}OptionC`).value = '';
            document.getElementById(`${subject}OptionD`).value = '';
            document.getElementById(`${subject}OptionE`).value = '';
            document.getElementById(`${subject}CorrectAnswer`).value = 'A';
            
            // Refresh the MCQ list
            if (currentUser && currentUser.role === 'admin') {
                loadAdminMCQs(subject);
            }
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        } catch (error) {
            statusDiv.innerHTML = '<div class="status-error">Error saving MCQ. Please try again.</div>';
        }
    }

    async function loadPolls(subject) {
        const pollsContainer = document.getElementById(`${subject}Polls`);
        
        try {
            const polls = await firebaseDB.getItem(`${subject}Polls`) || [];
            
            if (polls.length === 0) {
                const noPollsMsg = currentLanguage === 'si' ? 
                    '‡∂≠‡∑Ä‡∂∏ ‡∂°‡∂±‡∑ä‡∂Ø ‡∑Ä‡∑í‡∂∏‡∑É‡∑ì‡∂∏‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠.' : 
                    'No polls available yet.';
                pollsContainer.innerHTML = `<p style="color: #cccccc; text-align: center; padding: 20px;">${noPollsMsg}</p>`;
                return;
            }
            
            let pollsHTML = '';
            polls.forEach((poll, index) => {
                pollsHTML += `
                    <div class="poll-container">
                        <div class="poll-question">${index + 1}. ${poll.question}</div>
                        <button class="poll-option" onclick="selectPollOption(this, '${poll.id}', 'A', '${poll.correctAnswer}')">A) ${poll.options.A}</button>
                        <button class="poll-option" onclick="selectPollOption(this, '${poll.id}', 'B', '${poll.correctAnswer}')">B) ${poll.options.B}</button>
                        <button class="poll-option" onclick="selectPollOption(this, '${poll.id}', 'C', '${poll.correctAnswer}')">C) ${poll.options.C}</button>
                        <button class="poll-option" onclick="selectPollOption(this, '${poll.id}', 'D', '${poll.correctAnswer}')">D) ${poll.options.D}</button>
                        <button class="poll-option" onclick="selectPollOption(this, '${poll.id}', 'E', '${poll.correctAnswer}')">E) ${poll.options.E}</button>
                    </div>
                `;
            });
            
            pollsContainer.innerHTML = pollsHTML;
        } catch (error) {
            console.error('Error loading polls:', error);
            pollsContainer.innerHTML = '<p style="color: #f44336; text-align: center; padding: 20px;">Error loading polls. Please try again.</p>';
        }
    }

    async function loadAdminMCQs(subject) {
        const mcqListContainer = document.getElementById(`${subject}McqList`);
        
        try {
            const polls = await firebaseDB.getItem(`${subject}Polls`) || [];
            
            if (polls.length === 0) {
                mcqListContainer.innerHTML = '<div class="no-mcqs">No MCQs created yet. Add your first MCQ above!</div>';
                return;
            }
            
            let mcqHTML = '';
            polls.forEach((poll, index) => {
                const timestamp = new Date(poll.timestamp).toLocaleString();
                mcqHTML += `
                    <div class="mcq-item">
                        <div class="mcq-question">${index + 1}. ${poll.question}</div>
                        <div class="mcq-options">
                            <div class="mcq-option ${poll.correctAnswer === 'A' ? 'correct' : ''}">A) ${poll.options.A}</div>
                            <div class="mcq-option ${poll.correctAnswer === 'B' ? 'correct' : ''}">B) ${poll.options.B}</div>
                            <div class="mcq-option ${poll.correctAnswer === 'C' ? 'correct' : ''}">C) ${poll.options.C}</div>
                            <div class="mcq-option ${poll.correctAnswer === 'D' ? 'correct' : ''}">D) ${poll.options.D}</div>
                            <div class="mcq-option ${poll.correctAnswer === 'E' ? 'correct' : ''}">E) ${poll.options.E}</div>
                        </div>
                        <div class="mcq-actions">
                            <span class="mcq-timestamp">Created: ${timestamp}</span>
                            <button class="delete-btn" onclick="deleteMCQ('${subject}', ${poll.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            
            mcqListContainer.innerHTML = mcqHTML;
        } catch (error) {
            console.error('Error loading admin MCQs:', error);
            mcqListContainer.innerHTML = '<div class="no-mcqs">Error loading MCQs. Please try again.</div>';
        }
    }

    async function deleteMCQ(subject, mcqId) {
        if (!confirm('Are you sure you want to delete this MCQ? This action cannot be undone.')) {
            return;
        }
        
        try {
            const polls = await firebaseDB.getItem(`${subject}Polls`) || [];
            const updatedPolls = polls.filter(poll => poll.id !== mcqId);
            
            await firebaseDB.setItem(`${subject}Polls`, updatedPolls);
            
            loadAdminMCQs(subject);
            
            const statusDiv = document.getElementById(`${subject}McqStatus`);
            statusDiv.innerHTML = '<div class="status-success">MCQ deleted successfully!</div>';
            
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        } catch (error) {
            console.error('Error deleting MCQ:', error);
            const statusDiv = document.getElementById(`${subject}McqStatus`);
            statusDiv.innerHTML = '<div class="status-error">Error deleting MCQ. Please try again.</div>';
        }
    }

    // Real-time updates for polls (optional)
    function setupRealTimeUpdates() {
        // This will update polls in real-time when changes are made
        ['biology', 'chemistry', 'physics'].forEach(subject => {
            firebaseDB.onItemChange(`${subject}Polls`, (polls) => {
                if (currentUser && currentUser.role === 'student') {
                    loadPolls(subject);
                } else if (currentUser && currentUser.role === 'admin') {
                    loadAdminMCQs(subject);
                }
            });
        });
    }

    // Initialize real-time updates when user logs in
    const originalLoginHandler = document.getElementById('loginForm').onsubmit;
    document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (users[username] && users[username].password === password) {
            currentUser = { username, role: users[username].role };
            
            document.getElementById('loginSection').style.display = 'none';
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.add('active');
                loadAdminDashboard();
            } else {
                document.getElementById('studentDashboard').classList.add('active');
                loadStudentDashboard();
            }
            
            document.getElementById('errorMessage').innerHTML = '';
            
            await loadExamDates();
            startCountdowns();
            setupRealTimeUpdates(); // Initialize real-time updates
        } else {
            const errorMsg = currentLanguage === 'si' ? 
                '‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂±‡∑ú‡∑Ä‡∂± ‡∂Ö‡∂ö‡∑ä‡∂≠‡∂¥‡∂≠‡∑ä‚Äç‡∂ª. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.' : 
                'Invalid credentials. Please try again.';
            document.getElementById('errorMessage').innerHTML = 
                `<div class="error-alert">${errorMsg}</div>`;
        }
    };
</script>